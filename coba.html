<!DOCTYPE html>
<html lang="en" class="scroll-smooth bg-gray-900 text-gray-200">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DarkArena Sports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for dark */
    ::-webkit-scrollbar {
      width: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #1f2937;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 5px;
    }
    /* Popup animation */
    .popup-bg {
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }
    .fade-out {
      animation: fadeOut 0.3s ease forwards;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    @keyframes fadeOut {
      from {opacity: 1;}
      to {opacity: 0;}
    }
    /* Pastikan modal tetap full height dengan scroll automatic jika konten melebihi viewport */
  #videoPopup > div {
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Media query opsional untuk penyesuaian lebih spesifik jika mau */
  @media (max-width: 640px) {
    #videoPopup > div {
      max-width: 95vw;
    }
  }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header / Navbar -->
  <header class="sticky top-0 z-50 bg-gray-800 shadow-md">
    <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
      <h1 class="text-2xl font-bold text-indigo-400 cursor-default select-none">DarkArena Sports</h1>

      <div class="flex flex-wrap items-center gap-3 md:gap-6">
        <!-- Category Dropdown -->
        <select id="categorySelect" aria-label="Select Category" class="bg-gray-700 rounded-md px-3 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="all" selected>All Categories</option>
        </select>

        <!-- Search Input -->
        <input
          id="teamSearch"
          type="search"
          placeholder="Search Team..."
          class="bg-gray-700 rounded-md px-3 py-2 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          autocomplete="off"
          aria-label="Search Team"
        />

        <!-- Scroll to Top Button -->
        <button
          id="scrollTopBtn"
          title="Scroll to top"
          class="hidden fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full shadow-lg transition-opacity duration-300"
          aria-label="Scroll to top"
        >
          â†‘
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 flex-grow py-6">
    <div id="notification" class="fixed top-20 right-6 bg-indigo-600 text-white px-4 py-2 rounded shadow-md opacity-0 pointer-events-none transition-opacity duration-300 z-50" role="alert"></div>

    <!-- Matches List -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Matches</h2>
      <div id="matchesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Match cards will be appended here -->
      </div>
    </section>
  </main>

<!-- Popup Modal Embed Video -->
<div id="videoPopup" class="fixed inset-0 flex items-center justify-center z-50 hidden popup-bg p-4 bg-black bg-opacity-70" role="dialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupDesc">
  <div class="relative w-full max-w-4xl bg-gray-900 rounded-lg shadow-lg overflow-hidden">
    <!-- Tombol Close -->
    <button id="closePopupBtn" aria-label="Close Video" 
      class="absolute top-3 right-3 text-gray-300 hover:text-white text-3xl font-bold z-50 bg-gray-800 bg-opacity-70 rounded-full w-10 h-10 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
      style="line-height: 1;">&times;</button>

    <!-- Loading Spinner -->
    <div id="videoLoading" class="flex justify-center items-center" style="height: 0; padding-top: 56.25%; background-color: #2d3748; position: relative;">
      <svg class="animate-spin h-10 w-10 text-indigo-500 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" role="img" aria-label="Loading">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
    </div>

    <!-- Video Embed -->
    <div class="videoWrapper relative w-full" style="padding-top: 56.25%;">
      <iframe id="videoEmbed" class="absolute top-0 left-0 w-full h-full hidden" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>
    </div>

    <!-- Realtime Countdown Display -->
    <div id="countdownTimer" class="text-center text-indigo-400 text-lg font-mono mt-4 select-none"></div>

    <div id="streamSources" class="flex flex-wrap gap-2 bg-gray-800 p-3 overflow-x-auto"></div>
  </div>
</div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-gray-400 text-center py-6 mt-auto select-none">
    <p class="max-w-4xl mx-auto px-4">
      &copy; 2025 DarkArena Sports. Your ultimate dark-themed hub for live sports streams & match updates powered by Westream API.
    </p>
  </footer>

  <script>
    const API_BASE = 'https://westream.nu';

    // Elements
    const categorySelect = document.getElementById('categorySelect');
    const teamSearchInput = document.getElementById('teamSearch');
    const matchesContainer = document.getElementById('matchesContainer');
    const videoPopup = document.getElementById('videoPopup');
    const videoEmbed = document.getElementById('videoEmbed');
    const videoLoading = document.getElementById('videoLoading');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const streamSources = document.getElementById('streamSources');
    const notification = document.getElementById('notification');
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    
    const countdownTimer = document.getElementById('countdownTimer');

  let countdownInterval;

  closePopupBtn.addEventListener('click', () => {
    videoPopup.classList.add('hidden');
    videoEmbed.src = ''; // Reset src agar video berhenti
    videoEmbed.classList.add('hidden');
    videoLoading.style.display = 'flex';
    clearInterval(countdownInterval);
    countdownTimer.textContent = '';
  });

  // Fungsi load video dan mulai hitungan mundur 60 detik realtime
  function loadVideo(url) {
    videoEmbed.src = url;
    videoPopup.classList.remove('hidden');
    videoLoading.style.display = 'flex';
    videoEmbed.classList.add('hidden');

    let timeLeft = 60; // 60 detik
    countdownTimer.textContent = `Countdown: ${timeLeft}s`;

    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
      timeLeft--;
      countdownTimer.textContent = `Countdown: ${timeLeft}s`;

      if(timeLeft <= 0){
        clearInterval(countdownInterval);
        countdownTimer.textContent = 'Countdown selesai!';
        // Contoh aksi ketika timer selesai:
        alert('Waktu 60 detik sudah habis!');
        // Anda bisa tambahkan aksi lain di sini 
      }
    }, 1000);

    videoEmbed.onload = () => {
      videoLoading.style.display = 'none';
      videoEmbed.classList.remove('hidden');
    };
  }

    let allSports = [];
    let allMatches = [];
    let filteredMatches = [];
    let currentFilterCategory = 'all';
    let currentSearchTerm = '';
    let currentSelectedMatch = null;
    let currentSelectedStream = null;

    // Utility: Format timestamp to local date-time string
    function formatDate(unixMs) {
      const dt = new Date(unixMs);
      return dt.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
    }

    // Show notification
    function showNotification(message) {
      notification.textContent = message;
      notification.style.opacity = '1';
      notification.style.pointerEvents = 'auto';
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.pointerEvents = 'none';
      }, 3000);
    }

    // Fetch sports categories and fill dropdown
    async function fetchSports() {
      try {
        const resp = await fetch(`${API_BASE}/sports`);
        if (!resp.ok) throw new Error('Failed to fetch sports');
        const sports = await resp.json();
        allSports = sports;
        renderCategories();
      } catch (err) {
        showNotification('Error loading sports categories.');
        console.error(err);
      }
    }

    function renderCategories() {
      // Reset options, keep "All Categories"
      categorySelect.innerHTML = '<option value="all" selected>All Categories</option>';
      allSports.forEach(sport => {
        const opt = document.createElement('option');
        opt.value = sport.id;
        opt.textContent = sport.name;
        categorySelect.appendChild(opt);
      });
    }

    // Fetch matches (all or by sport)
    async function fetchMatches(sportId = 'all') {
      try {
        let url = sportId === 'all' ? `${API_BASE}/matches` : `${API_BASE}/matches/${encodeURIComponent(sportId)}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Failed to fetch matches');
        const matches = await resp.json();
        allMatches = matches;
        applyFilters();
      } catch (err) {
        showNotification('Error loading matches.');
        console.error(err);
      }
    }

    // Filter by category and team search
    function applyFilters() {
      filteredMatches = allMatches.filter(match => {
        const matchCategory = match.category.toLowerCase();
        if (currentFilterCategory !== 'all' && matchCategory !== currentFilterCategory.toLowerCase()) {
          return false;
        }
        if (currentSearchTerm) {
          const search = currentSearchTerm.toLowerCase();
          let home = match.teams?.home?.name?.toLowerCase() || '';
          let away = match.teams?.away?.name?.toLowerCase() || '';
          if (!home.includes(search) && !away.includes(search) && !match.title.toLowerCase().includes(search)) {
            return false;
          }
        }
        return true;
      });
      renderMatches();
    }

    // Render the list of matches
    function renderMatches() {
      matchesContainer.innerHTML = '';
      if (filteredMatches.length === 0) {
        matchesContainer.innerHTML = `<p class="text-center text-gray-400 col-span-full">No matches found.</p>`;
        return;
      }
      filteredMatches.forEach(match => {
        const card = document.createElement('article');
        card.className = 'bg-gray-800 p-4 rounded shadow hover:shadow-indigo-600 transition-shadow flex flex-col justify-between';

        // Title and date
        const title = document.createElement('h3');
        title.className = 'font-semibold text-lg mb-1';
        title.textContent = match.title;
        card.appendChild(title);

        const date = document.createElement('time');
        date.className = 'text-sm text-gray-400 mb-2';
        date.dateTime = new Date(match.date).toISOString();
        date.textContent = formatDate(match.date);
        card.appendChild(date);

        // Teams
        if (match.teams) {
          const teamsDiv = document.createElement('div');
          teamsDiv.className = 'mb-3 flex justify-between text-indigo-300 font-medium';

          const homeTeam = document.createElement('span');
          homeTeam.textContent = match.teams.home?.name || 'TBD';
          teamsDiv.appendChild(homeTeam);

          const vs = document.createElement('span');
          vs.textContent = 'vs';
          vs.className = 'mx-2 text-gray-400 italic';
          teamsDiv.appendChild(vs);

          const awayTeam = document.createElement('span');
          awayTeam.textContent = match.teams.away?.name || 'TBD';
          teamsDiv.appendChild(awayTeam);

          card.appendChild(teamsDiv);
        }

        // Popular tag
        if (match.popular) {
          const popularBadge = document.createElement('span');
          popularBadge.textContent = 'Popular';
          popularBadge.className = 'inline-block bg-indigo-600 text-indigo-100 px-2 py-0.5 rounded text-xs font-semibold mb-2 w-fit';
          card.appendChild(popularBadge);
        }

        // Button watch
        const btnWatch = document.createElement('button');
        btnWatch.textContent = 'Watch';
        btnWatch.className = 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-2 px-4 rounded shadow-md transition';
        btnWatch.setAttribute('aria-label', `Watch match: ${match.title}`);
        btnWatch.addEventListener('click', () => openWatchPopup(match));
        card.appendChild(btnWatch);

        matchesContainer.appendChild(card);
      });
    }

    // Open popup with video embed, handle ads tabs and streams
    async function openWatchPopup(match) {
      // Open ads tab
      window.open('https://www.profitableratecpm.com/asy7nn44y1?key=fb244c9fcb6018b78e6640d5ee73066f', '_blank', 'noopener');

      currentSelectedMatch = match;
      videoPopup.classList.remove('hidden');
      videoPopup.classList.remove('fade-out');
      videoPopup.classList.add('fade-in');

      videoEmbed.style.display = 'none';
      videoLoading.style.display = 'flex';
      streamSources.innerHTML = '';

      try {
        // Fetch streams for first source
        // We will show all sources and languages as buttons below video to allow user switch if available
        if (!match.sources?.length) {
          throw new Error('No sources available for this match.');
        }
        // Fetch streams from first source's id here by /stream/:source/:id
        let streamsAll = [];
        for (const sourceObj of match.sources) {
          let sUrl = `${API_BASE}/stream/${encodeURIComponent(sourceObj.source)}/${encodeURIComponent(sourceObj.id)}`;
          const resp = await fetch(sUrl);
          if (!resp.ok) continue;
          const streams = await resp.json();
          streamsAll = streamsAll.concat(streams);
        }
        if (streamsAll.length === 0) throw new Error('No streams found.');

        // Store streams list and select first as default
        currentSelectedStream = streamsAll[0];

        // Render stream source buttons
        streamsAll.forEach(stream => {
          const btn = document.createElement('button');
          btn.className = `px-3 py-1 rounded border border-indigo-500 text-indigo-400 hover:bg-indigo-600 hover:text-white transition`;
          btn.textContent = `${stream.language.toUpperCase()}${stream.hd ? ' HD' : ''} [#${stream.streamNo}]`;
          btn.addEventListener('click', () => selectStream(stream));
          streamSources.appendChild(btn);
        });

        setEmbedUrl(currentSelectedStream.embedUrl);

      } catch (err) {
        videoLoading.style.display = 'flex';
        videoEmbed.style.display = 'none';
        streamSources.innerHTML = `<p class="text-red-500 p-4">Failed to load streams: ${err.message}</p>`;
        console.error(err);
      }
    }

    function setEmbedUrl(url) {
      videoEmbed.style.display = 'none';
      videoLoading.style.display = 'flex';

      // Load embed url in iframe with a slight delay to show loading spinner
      setTimeout(() => {
        videoEmbed.src = url;
        videoEmbed.onload = () => {
          videoLoading.style.display = 'none';
          videoEmbed.style.display = 'block';
        }
      }, 300);
    }

    // Switch stream source
    function selectStream(stream) {
      currentSelectedStream = stream;
      setEmbedUrl(stream.embedUrl);
    }

    // Close popup
    function closePopup() {
      videoPopup.classList.remove('fade-in');
      videoPopup.classList.add('fade-out');
      videoEmbed.src = '';
      currentSelectedMatch = null;
      currentSelectedStream = null;

      // Open another ads tab on close
      window.open('https://www.profitableratecpm.com/asy7nn44y1?key=fb244c9fcb6018b78e6640d5ee73066f', '_blank', 'noopener');

      setTimeout(() => {
        videoPopup.classList.add('hidden');
      }, 300);
    }

    // Event listeners
    categorySelect.addEventListener('change', e => {
      currentFilterCategory = e.target.value;
      fetchMatches(currentFilterCategory !== 'all' ? currentFilterCategory : 'all');
    });

    teamSearchInput.addEventListener('input', e => {
      currentSearchTerm = e.target.value.trim();
      applyFilters();
    });

    closePopupBtn.addEventListener('click', closePopup);

    // Scroll to top button functionality
    window.addEventListener('scroll', () => {
      if (window.scrollY > 400) {
        scrollTopBtn.classList.remove('hidden');
      } else {
        scrollTopBtn.classList.add('hidden');
      }
    });

    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({top: 0, behavior: 'smooth'});
    });

    // Initialize on load
    async function init() {
      await fetchSports();
      await fetchMatches();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
